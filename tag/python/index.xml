<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Python | Felipe Sodr√© M. Barros</title>
    <link>/tag/python/</link>
      <atom:link href="/tag/python/index.xml" rel="self" type="application/rss+xml" />
    <description>Python</description>
    <generator>Wowchemy (https://wowchemy.com)</generator><language>en-us</language><lastBuildDate>Sat, 04 Jun 2022 00:00:00 +0000</lastBuildDate>
    <image>
      <url>/images/icon_huf522d53bb96c01347942c9c8d4a9566b_18603_512x512_fill_lanczos_center_2.png</url>
      <title>Python</title>
      <link>/tag/python/</link>
    </image>
    
    <item>
      <title>Criando um sistema para gest√£o de dados geogr√°ficos de forma simples e robusta III</title>
      <link>/post/sistema-dados-geograficos-iii/</link>
      <pubDate>Sat, 04 Jun 2022 00:00:00 +0000</pubDate>
      <guid>/post/sistema-dados-geograficos-iii/</guid>
      <description>&lt;p&gt;Caso n√£o tenha visto as publica√ß√µes anteriores, deixo aqui o &lt;em&gt;link&lt;/em&gt; e os temas abordados:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://www.linkedin.com/pulse/criando-um-sistema-para-gest%C3%A3o-de-dados-geogr%C3%A1ficos-e-felipe-/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Na primeira publica√ß√£o&lt;/a&gt; falo sobre o &lt;a href=&#34;https://django-geojson.readthedocs.io/en/latest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;django-geojson&lt;/code&gt;&lt;/a&gt; para simular um campo geogr√°fico no models; o &lt;a href=&#34;https://geojson.readthedocs.io/en/latest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;geojson&lt;/code&gt;&lt;/a&gt; para criar um objeto da classe &lt;em&gt;geojson&lt;/em&gt; e realizar as valida√ß√µes necess√°rias para garantir robustez do sistema, e a cria√ß√£o do formul√°rio de registro de dados usando o &lt;a href=&#34;https://docs.djangoproject.com/en/3.2/topics/forms/modelforms/#modelform&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;ModelForm&lt;/code&gt;&lt;/a&gt;;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.linkedin.com/pulse/criando-um-sistema-para-gest%C3%A3o-de-dados-geogr%C3%A1ficos-e-felipe--1e/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Na segunda publica√ß√£o&lt;/a&gt; apresento os validadores de campo do &lt;code&gt;Django&lt;/code&gt; como uma ferramenta fundamental na qualidade dos dados espaciais, &lt;strong&gt;sem depender de infraestrutura SIG (GIS)&lt;/strong&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Agora a ideia √© implementar um &lt;em&gt;webmap&lt;/em&gt; usando o m√≥dulo &lt;a href=&#34;https://django-leaflet.readthedocs.io/en/latest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;django-leaflet&lt;/code&gt;&lt;/a&gt; para apresentar os fen√¥menos mapeados com algumas informa√ß√µes no &lt;em&gt;popup&lt;/em&gt; do mapa. Para isso iremos:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;usar o &lt;code&gt;GeoJSONLayerView&lt;/code&gt;, do &lt;a href=&#34;https://django-geojson.readthedocs.io/en/latest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;django-geojson&lt;/code&gt;&lt;/a&gt; para retornar os dados salvos no formato apropriado para exibi√ß√£o no &lt;em&gt;webmap&lt;/em&gt;;&lt;/li&gt;
&lt;li&gt;usar o &lt;a href=&#34;https://django-leaflet.readthedocs.io/en/latest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;django-leaflet&lt;/code&gt;&lt;/a&gt; para, al√©m de implementar o &lt;em&gt;webmap&lt;/em&gt;, podermos usar v√°rias outras ferramentas (&lt;code&gt;widget&lt;/code&gt;);&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Vamos l√°!&lt;/p&gt;
&lt;h2 id=&#34;view-geojsonlayerview&#34;&gt;View GeoJSONLayerView&lt;/h2&gt;
&lt;p&gt;A serializa√ß√£o ou, em ingl√™s &lt;code&gt;serialization&lt;/code&gt;, √© o processo/mecanismo de tradu√ß√£o dos objetos armazenados na base de dados em outros formatos (em geral, baseado em texto como, por exemplo, XML ou JSON), para serem enviados e/ou consumidos no processo de &lt;em&gt;request/response&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;No nosso caso isso ser√° importante, pois para apresentar os dados salvos em um &lt;em&gt;webmap&lt;/em&gt;, precisaremos servi-los no formato &lt;code&gt;geojson&lt;/code&gt;. E √© a√≠ que o &lt;code&gt;django-geojson&lt;/code&gt; entra. N√≥s o utilizaremos para fazer a m√°gica acontecer ao usar a classe &lt;a href=&#34;https://django-geojson.readthedocs.io/en/latest/views.html#geojson-layer-view&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;GeoJSONLayerView&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;A classe &lt;code&gt;GeoJSONLayerView&lt;/code&gt; √© um &lt;a href=&#34;https://docs.djangoproject.com/en/3.2/topics/class-based-views/mixins/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;mixin&lt;/code&gt;&lt;/a&gt; que, em base ao modelo informado do nosso projeto, serializa os dados transformando-os em &lt;code&gt;geojson&lt;/code&gt; e os servindo em uma &lt;code&gt;view&lt;/code&gt;. Acredite, √© bastante coisa para apenas algumas linhas de c√≥digo.&lt;/p&gt;
&lt;p&gt;Para entender a serializa√ß√£o, segue um exemplo&amp;hellip;&lt;/p&gt;
&lt;p&gt;Ao acessar os dados do banco de dados do nosso projeto, temos uma &lt;code&gt;QuerySet&lt;/code&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;&amp;gt;&amp;gt;&amp;gt; Fenomeno.objects.all()
&amp;lt;QuerySet [&amp;lt;Fenomeno: fenomeno_teste&amp;gt;]&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Ao acessar a geometria de um objeto do banco de dados do nosso projeto, temos um &lt;code&gt;geojson&lt;/code&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;&amp;gt;&amp;gt;&amp;gt; Fenomeno.objects.get(pk=3).geom
{&#39;type&#39;: &#39;Point&#39;, &#39;coordinates&#39;: [-42.0, -22.0]}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Ao serializ√°-lo com o &lt;code&gt;GeoJSONSerializer&lt;/code&gt;, temos como retorno uma &lt;a href=&#34;https://datatracker.ietf.org/doc/html/rfc7946#section-3.3&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;FeatureCollection&lt;/code&gt;&lt;/a&gt; seguindo o formato &lt;code&gt;geojson&lt;/code&gt;, tendo como propriedades os campos do &lt;code&gt;model&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;&amp;gt;&amp;gt;&amp;gt; from djgeojson.serializers import Serializer as GeoJSONSerializer
&amp;gt;&amp;gt;&amp;gt; GeoJSONSerializer().serialize(Fenomeno.objects.all(), use_natural_keys=True, with_modelname=False)
&#39;{&#39;crs&#39;: {&#39;properties&#39;: {&#39;href&#39;: &#39;http://spatialreference.org/ref/epsg/4326/&#39;,
                        &#39;type&#39;: &#39;proj4&#39;},
         &#39;type&#39;: &#39;link&#39;},
 &#39;features&#39;: [{&#39;geometry&#39;: {&#39;coordinates&#39;: [-42.0, -22.0], &#39;type&#39;: &#39;Point&#39;},
               &#39;id&#39;: 3,
               &#39;properties&#39;: {&#39;data&#39;: &#39;2021-06-22&#39;,
                              &#39;hora&#39;: &#39;02:07:57&#39;,
                              &#39;nome&#39;: &#39;teste&#39;},
               &#39;type&#39;: &#39;Feature&#39;}],
 &#39;type&#39;: &#39;FeatureCollection&#39;}&#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Mais sobre serializa√ß√£o pode ser encontrado &lt;a href=&#34;https://django-portuguese.readthedocs.io/en/1.0/topics/serialization.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;aqui&lt;/a&gt; ou &lt;a href=&#34;https://docs.djangoproject.com/en/3.2/ref/contrib/gis/serializers/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;aqui, com outro exemplo relacionado a dado geogr√°fico usando o GeoDjango&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Ent√£o, ciente de toda a m√°gica por tr√°s do &lt;code&gt;GeoJSONLayerView&lt;/code&gt; e o seu resultado, vamos criar os testes para essa &lt;code&gt;view&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&#34;criando-os-testes-da-view&#34;&gt;Criando os testes da &lt;code&gt;view&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Como estou testando justamente uma &lt;code&gt;view&lt;/code&gt; que serializa o objeto do meu modelo em formato &lt;code&gt;geojson&lt;/code&gt;, precisarei desses dados salvos no banco de dados. Para tanto, vou adicionar ao &lt;code&gt;setUp&lt;/code&gt; do meu &lt;code&gt;TestCase&lt;/code&gt; valores v√°lidos ao banco de dados do teste. Sem isso, n√£o poderemos confirmar se a serializa√ß√£o est√° ocorrendo de forma correta. E, uma vez salvo, realizo um conjunto b√°sico de testes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Confirmo se o &lt;em&gt;status code&lt;/em&gt; do request (m√©todo &amp;ldquo;get&amp;rdquo;) ao &lt;em&gt;path&lt;/em&gt; que pretendo usar para essa views (no caso, &amp;ldquo;/geojson/&amp;quot;), retorna 200, c√≥digo que indica sucesso no processo de &lt;em&gt;request/response&lt;/em&gt;. &lt;a href=&#34;https://en.wikipedia.org/wiki/List_of_HTTP_status_codes&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Veja mais sobre os c√≥digos aqui&lt;/a&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Em seguida, confirmo se a resposta recebida √© uma &lt;code&gt;FetureCollection&lt;/code&gt; com os dados da inst√¢ncia criada anteriormente.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# testes.py
class FenomenoGeoJsonTest(TestCase):
    def setUp(self):
        Fenomeno.objects.create(
            nome=&amp;quot;Teste&amp;quot;,
            data=&amp;quot;2020-01-01&amp;quot;,
            hora=&amp;quot;09:12:12&amp;quot;,
            geom={&amp;quot;type&amp;quot;: &amp;quot;Point&amp;quot;, &amp;quot;coordinates&amp;quot;: [-42, -22]},
        )

    def teste_geojson_status_code(self):
        self.resp = self.client.get(r(&amp;quot;geojson&amp;quot;))
        self.assertEqual(200, self.resp.status_code)

    def teste_path_geojson_returns_valid_feature_collection(self):
        self.resp = self.client.get(r(&amp;quot;geojson&amp;quot;))
        self.assertEqual(
            self.resp.json(),
            {
                &amp;quot;type&amp;quot;: &amp;quot;FeatureCollection&amp;quot;,
                &amp;quot;features&amp;quot;: [
                    {
                        &amp;quot;type&amp;quot;: &amp;quot;Feature&amp;quot;,
                        &amp;quot;properties&amp;quot;: {
                            &amp;quot;popup_content&amp;quot;: &amp;quot;&amp;lt;p&amp;gt;&amp;lt;strong&amp;gt;&amp;lt;span&amp;gt;Nome: &amp;lt;/span&amp;gt;Teste&amp;lt;/strong&amp;gt;&amp;lt;/p&amp;gt;&amp;quot;,
                            &amp;quot;model&amp;quot;: &amp;quot;core.fenomeno&amp;quot;,
                        },
                        &amp;quot;id&amp;quot;: 1,
                        &amp;quot;geometry&amp;quot;: {&amp;quot;type&amp;quot;: &amp;quot;Point&amp;quot;, &amp;quot;coordinates&amp;quot;: [-42.0, -22.0]},
                    }
                ],
                &amp;quot;crs&amp;quot;: {&amp;quot;type&amp;quot;: &amp;quot;name&amp;quot;, &amp;quot;properties&amp;quot;: {&amp;quot;name&amp;quot;: &amp;quot;EPSG:4326&amp;quot;}},
            },
        )

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Obviamente, ambos testes falhar√£o, pois, ainda n√£o criamos a view e nem a designamos a um &lt;em&gt;path&lt;/em&gt; do nosso sistema.&lt;/p&gt;
&lt;p&gt;Para faz√™-los passar, vamos primeiro criar a view: Em &lt;code&gt;views.py&lt;/code&gt; criaremos uma classe nova, herdando da classe &lt;code&gt;GeoJSONLayerView&lt;/code&gt;. Ela ser√° a view respons√°vel por resgatar os dados e servir-nos como uma &lt;code&gt;FeatureCollection&lt;/code&gt; seguindo a estrutura de um &lt;code&gt;geojson&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Um √∫ltimo detalhe √© que, como estamos usando um &lt;code&gt;Class Based-View&lt;/code&gt;, ao final a convertemos em view, com o m√©todo &lt;code&gt;as_view()&lt;/code&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# views.py
from djgeojson.views import GeoJSONLayerView

from map_proj.core.models import Fenomeno


class FenomenoGeoJson(GeoJSONLayerView):
    model = Fenomeno
    properties = (&amp;quot;popup_content&amp;quot;,)


fenomeno_geojson = FenomenoGeoJson.as_view()

&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;adicionando-propriedade-para-popup&#34;&gt;Adicionando propriedade para &lt;em&gt;popup&lt;/em&gt;&lt;/h3&gt;
&lt;p&gt;Percebam que no &lt;code&gt;teste_geojson_FeatureCollection&lt;/code&gt; eu j√° estou considerando que o &lt;code&gt;geojson&lt;/code&gt; vir√° com &lt;code&gt;properties&lt;/code&gt; com o nome de &lt;code&gt;popup-content&lt;/code&gt;. Essa &lt;code&gt;property&lt;/code&gt; ainda dever√° ser criada no model em quest√£o e poder√° ter quantas informa√ß√µes acharmos pertinentes. Se tratam das informa√ß√µes do model a serem apresentadas no &lt;em&gt;popup&lt;/em&gt; do mapa.&lt;/p&gt;
&lt;p&gt;Por agora estou apenas informando o nome do fen√¥meno mapeado mas, mais √† frente, podemos incrementar, adicionando um &lt;a href=&#34;https://docs.djangoproject.com/en/3.2/ref/models/instances/#get-absolute-url&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;get_absolute_url&lt;/code&gt;&lt;/a&gt; por exemplo, para poder acessar aos detalhes do fen√¥meno diretamente a partir do &lt;em&gt;popup&lt;/em&gt; do mapa.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#models.py
...
    @property
    def popup_content(self):
        return self.nome
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;adicionando-um-path-a-view&#34;&gt;Adicionando um &lt;em&gt;path&lt;/em&gt; a &lt;code&gt;view&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Para poder acessar essa view, precisamos incorpor√°-la na nossa &lt;code&gt;urls.py&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# urls.py
from django.contrib import admin
from django.urls import path

from map_proj.core.views import fenomeno_geojson # novo!

urlpatterns = [
    path(&amp;quot;admin/&amp;quot;, admin.site.urls),
    path(&amp;quot;geojson/&amp;quot;, fenomeno_geojson, name=&amp;quot;geojson&amp;quot;), # novo!
]

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Com isso teremos os nossos √∫ltimos testes passando. Se ainda assim voc√™ tiver curiosidade, pode executar o &lt;code&gt;runserver&lt;/code&gt; e acessar os dados pela &lt;em&gt;url&lt;/em&gt; &lt;code&gt;http://127.0.0.1:8000/geojson/&lt;/code&gt;. O resultado esperado s√£o os dados servidos em &lt;code&gt;geojson&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{
                &amp;quot;type&amp;quot;: &amp;quot;FeatureCollection&amp;quot;,
                &amp;quot;features&amp;quot;: [
                    {
                        &amp;quot;type&amp;quot;: &amp;quot;Feature&amp;quot;,
                        &amp;quot;properties&amp;quot;: {
                            &amp;quot;popup_content&amp;quot;: &amp;quot;&amp;lt;p&amp;gt;&amp;lt;strong&amp;gt;&amp;lt;span&amp;gt;Nome: &amp;lt;/span&amp;gt;Teste&amp;lt;/strong&amp;gt;&amp;lt;/p&amp;gt;&amp;quot;,
                            &amp;quot;model&amp;quot;: &amp;quot;core.fenomeno&amp;quot;,
                        },
                        &amp;quot;id&amp;quot;: 1,
                        &amp;quot;geometry&amp;quot;: {&amp;quot;type&amp;quot;: &amp;quot;Point&amp;quot;, &amp;quot;coordinates&amp;quot;: [-42.0, -22.0]},
                    }
                ],
                &amp;quot;crs&amp;quot;: {&amp;quot;type&amp;quot;: &amp;quot;name&amp;quot;, &amp;quot;properties&amp;quot;: {&amp;quot;name&amp;quot;: &amp;quot;EPSG:4326&amp;quot;}},
            }
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;‚ö†Ô∏è Garanta que voc√™ j√° tenha inserido algum dado ao seu projeto ;)&lt;/p&gt;
&lt;p&gt;Pronto, j√° temos uma &lt;code&gt;view&lt;/code&gt; nos servindo os dados em formato &lt;code&gt;geojson&lt;/code&gt;. Vamos ao &lt;code&gt;Django-leaflet&lt;/code&gt;, para entender como montar um &lt;em&gt;webmap&lt;/em&gt;.&lt;/p&gt;
&lt;h2 id=&#34;django-leaflet&#34;&gt;Django-leaflet&lt;/h2&gt;
&lt;p&gt;Para saber mais sobre o &lt;code&gt;django-leaflet&lt;/code&gt;, recomendo dar uma olhada na p√°gina &lt;a href=&#34;https://pypi.org/project/django-leaflet/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;pypi&lt;/a&gt; e na &lt;a href=&#34;https://django-leaflet.readthedocs.io/en/latest/installation.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;documenta√ß√£o&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Voc√™ deve estar se perguntando: &amp;ldquo;por qu√™ usar o &lt;code&gt;django-leaflet&lt;/code&gt; se eu posso usar o &lt;a href=&#34;https://leafletjs.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;leaflet&lt;/code&gt;&lt;/a&gt; &amp;ldquo;puro&amp;rdquo;, j√° que se trata de uma biblioteca JavaScript para produ√ß√£o do mapa no &lt;em&gt;frontend&lt;/em&gt;?&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;Os autores do projeto &lt;code&gt;django-leaflet&lt;/code&gt; deixam alguns pontos que justificam sua ado√ß√£o na p√°gina da documenta√ß√£o. Das quais eu destaco:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Possibilidade de uso das ferramentas de edi√ß√£o de geometr√≠a usando os &lt;code&gt;widget&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;F√°cil integra√ß√£o dos &lt;code&gt;widgets&lt;/code&gt; na p√°gina &lt;code&gt;admin&lt;/code&gt; do Django;&lt;/li&gt;
&lt;li&gt;Controle da apar√™ncia dos mapas a partir do Django &lt;code&gt;settings.py&lt;/code&gt;;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;‚ö†Ô∏è E por √∫ltimo, mas n√£o menos importante:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;django-leaflet&lt;/code&gt; √© compat√≠vel com os campos  &lt;code&gt;django-geojson&lt;/code&gt;, o que permite o uso de dados geogr√°ficos sem a necessidade de uma base de dados espaciais. O motivo de toda essa s√©rie que tenho produzido :)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Bem legal! Eles criaram um pacote j√° compat√≠vel com o pacote &lt;code&gt;django-geojson&lt;/code&gt;, que nos permite simular campos geogr√°ficos sem a necessidade de toda a infraestrutura de uma base de dados de SIG (PostGIS, por exemplo).&lt;/p&gt;
&lt;p&gt;‚ö†Ô∏è Por√©m, aten√ß√£o ao seguinte detalhe:+&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;O &lt;code&gt;django-leaflet&lt;/code&gt; depende da biblioteca &lt;a href=&#34;https://pypi.org/project/GDAL/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;GDAL&lt;/a&gt;, n√£o se esque√ßa de instal√°-la antes.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;instalando-django-leaflet&#34;&gt;Instalando &lt;code&gt;django-leaflet&lt;/code&gt;&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;pip install django-leaflet
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Ap√≥s a sua instala√ß√£o √© necess√°rio inclu√≠-lo no &lt;code&gt;settings.py&lt;/code&gt; como &lt;em&gt;INSTALLED_APPS&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;‚ö†Ô∏è N√£o esque√ßa de adicion√°-lo ao &lt;code&gt;requirements.txt&lt;/code&gt; do projeto, tamb√©m.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# settings.py
INSTALLED_APPS = [
    ...
    &#39;djgeojson&#39;,
    &#39;leaflet&#39;, # novo
    ...
]
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;usando-o-leaflet&#34;&gt;Usando o leaflet&lt;/h3&gt;
&lt;p&gt;Com &lt;code&gt;leaflet&lt;/code&gt; instalado, devemos ent√£o:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Na pasta da nossa &lt;em&gt;app&lt;/em&gt;, vamos criar uma pasta chamada &amp;ldquo;templates&amp;rdquo;;&lt;/li&gt;
&lt;li&gt;E nessa pasta, criar um arquivo HTML (neste caso vou chamar de &amp;ldquo;map.html&amp;rdquo;;&lt;/li&gt;
&lt;li&gt;Nessa p√°gina vamos carregar as &lt;a href=&#34;https://www.geeksforgeeks.org/django-template-tags/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;template_tags&lt;/code&gt;&lt;/a&gt; do &lt;code&gt;leaflet&lt;/code&gt; para poder usar &lt;code&gt;leaflet_js&lt;/code&gt;, &lt;code&gt;leaflet_css&lt;/code&gt; e o &lt;code&gt;leaflet_map&lt;/code&gt;:&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Nosso &lt;code&gt;map.html&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;{% load leaflet_tags %}

&amp;lt;head&amp;gt;
    ...
    {% leaflet_js %}
    {% leaflet_css %}
&amp;lt;/head&amp;gt;
...
&amp;lt;body&amp;gt;
    ...
    {% leaflet_map &amp;quot;yourmap&amp;quot; %}
    ...
&amp;lt;/body&amp;gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Essas &lt;a href=&#34;https://github.com/makinacorpus/django-leaflet/blob/master/leaflet/templatetags/leaflet_tags.py&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;template_tags&lt;/code&gt;&lt;/a&gt; ir√£o tentar acessar as configura√ß√µes do &lt;code&gt;leaflet&lt;/code&gt; presentes no &lt;code&gt;settings.py&lt;/code&gt; da app, caso existam. Do contr√°rio, ser√£o usados valores padr√£o de configura√ß√£o. O interessante dessas &lt;code&gt;template_tags&lt;/code&gt; √© que com elas podemos customizar tais configura√ß√µes a cada &lt;em&gt;template&lt;/em&gt;;&lt;/p&gt;
&lt;ol start=&#34;5&#34;&gt;
&lt;li&gt;Como a ideia √© apenas renderizar essa p√°gina, vou adicionar ao &lt;code&gt;urls.py&lt;/code&gt; um &lt;em&gt;path&lt;/em&gt; a ela, usando o &lt;a href=&#34;https://docs.djangoproject.com/en/4.0/topics/class-based-views/#basic-examples&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;TemplateView&lt;/code&gt;&lt;/a&gt;. Com isso, ao receber um &lt;em&gt;request&lt;/em&gt; neste &lt;em&gt;path&lt;/em&gt;, a responsta ser√° direcionada √† renderiza√ß√£o dessa p√°gina:&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#urls.py
from django.contrib import admin
from django.urls import path
from django.views.generic import TemplateView

from map_proj.core.views import fenomeno_geojson

urlpatterns = [
    path(&amp;quot;admin/&amp;quot;, admin.site.urls),
    path(&amp;quot;geojson/&amp;quot;, fenomeno_geojson, name=&amp;quot;geojson&amp;quot;),
    path(&amp;quot;map/&amp;quot;, TemplateView.as_view(template_name=&amp;quot;map.html&amp;quot;), name=&amp;quot;map&amp;quot;),
]

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Isso j√° o suficiente para termos nosso &lt;em&gt;webmap&lt;/em&gt; apresentado:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./img/leaflet_1.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Imagino que n√£o seja o que esperava, n√©? Fique calmo. O leaflet buscou as configura√ß√µes do mapa e, como n√£o encontrou, retornou o mesmo com as configura√ß√µes padr√£o. Veremos em breve como alterar as configura√ß√µes do mapa.&lt;/p&gt;
&lt;p&gt;Antes disso, vamos &amp;ldquo;linkar&amp;rdquo; a view que nos serve o &lt;code&gt;geojson&lt;/code&gt; com os dados salvos no banco com o &lt;em&gt;webmap&lt;/em&gt; em quest√£o, para que os dados sejam apresentados.&lt;/p&gt;
&lt;h3 id=&#34;renderizando-o-geojson-no-mapa&#34;&gt;Renderizando o &lt;code&gt;geojson&lt;/code&gt; no mapa&lt;/h3&gt;
&lt;p&gt;Lembra que temos uma view que serializa os dados armazenados no banco e nos serve como uma &lt;code&gt;FeatureCollection&lt;/code&gt; e que podemos acessar tais dados pelo &lt;em&gt;path&lt;/em&gt; &lt;em&gt;geojson/&lt;/em&gt;?&lt;/p&gt;
&lt;p&gt;Ent√£o, iremos adicionar um &lt;em&gt;script&lt;/em&gt; √† nossa p√°gina no qual uma vari√°vel &lt;code&gt;dataurl&lt;/code&gt; receber√° os dados dessa &lt;em&gt;url&lt;/em&gt; adicionando tais dados ao mapa, assim que o mesmo for inicializado, desencadeando o processo de constru√ß√£o da &lt;em&gt;popup&lt;/em&gt; de cada fei√ß√£o apresentada com sua posterior inser√ß√£o ao mapa:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;{% load leaflet_tags %}

    &amp;lt;script&amp;gt;
      var dataurl = &#39;{% url &amp;quot;geojson&amp;quot; %}&#39;;

      window.addEventListener(&amp;quot;map:init&amp;quot;, function (event) {
        var map = event.detail.map;
        // Download GeoJSON data with Ajax
        fetch(dataurl)
          .then(function(resp) {
            return resp.json();
          })
          .then(function(data) {
            L.geoJson(data, {
              onEachFeature: function onEachFeature(feature, layer) {
                var props = &amp;quot;&amp;lt;p&amp;gt;&amp;lt;strong&amp;gt;&amp;lt;span&amp;gt;Nome: &amp;lt;/span&amp;gt; &amp;quot; + feature.properties.popup_content + &amp;quot;&amp;lt;/strong&amp;gt;&amp;lt;/p&amp;gt;&amp;quot;;
                layer.bindPopup(props);
            }}).addTo(map);
          });
      });

    &amp;lt;/script&amp;gt;



&amp;lt;head&amp;gt;
    {% leaflet_js %}
    {% leaflet_css %}
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;

{% leaflet_map &amp;quot;yourmap&amp;quot; %}

&amp;lt;/body&amp;gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Veja que, para a cria√ß√£o da vari√°vel &lt;code&gt;dataurl&lt;/code&gt;, estamos usando a &lt;code&gt;template_tag&lt;/code&gt; do django:
&lt;code&gt;var dataurl = &#39;{% url &amp;quot;geojson&amp;quot; %}&#39;;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Veja mais sobre ela &lt;a href=&#34;https://docs.djangoproject.com/en/4.0/ref/templates/builtins/#url&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;aqui&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Repare tamb√©m que, neste processo, a cada &lt;code&gt;Feature&lt;/code&gt;, ser√° carregada as suas propriedades a serem apresentadas no &lt;em&gt;popup&lt;/em&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;L.geoJson(data, {
              onEachFeature: function onEachFeature(feature, layer) {
                var props = &amp;quot;&amp;lt;p&amp;gt;&amp;lt;strong&amp;gt;&amp;lt;span&amp;gt;Nome: &amp;lt;/span&amp;gt; &amp;quot; + feature.properties.popup_content + &amp;quot;&amp;lt;/strong&amp;gt;&amp;lt;/p&amp;gt;&amp;quot;;
                layer.bindPopup(props);
            }}).addTo(map);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Com o &lt;code&gt;runserver&lt;/code&gt; em execu√ß√£o, j√° poderemos ver o nosso mapa com o dado carregado e as propriedades que definimos no &lt;em&gt;popup&lt;/em&gt;:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./img/leaflet_2.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;‚ö†Ô∏è Garanta que voc√™ j√° tenha inserido algum dado ao seu projeto ;)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Mudando o tamanho do &lt;em&gt;webmap&lt;/em&gt;:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Antes de passarmos √†s configura√ß√µes do &lt;code&gt;leaflet&lt;/code&gt;, podemos alterar as dimens√µes do mapa definindo um &lt;code&gt;style&lt;/code&gt;. Por exemplo, para que o mapa ocupe toda a √°rea poss√≠vel do navegador, basta adicionarmos:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;&amp;lt;style&amp;gt;
    #yourmap {
        width: 100%;
        height: 100%;
    }
&amp;lt;/style&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;./img/leaflet_3.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;configura√ß√µes-do-leaflet&#34;&gt;Configura√ß√µes do leaflet&lt;/h3&gt;
&lt;p&gt;Bom, al√©m das &lt;code&gt;template_tags&lt;/code&gt; do leaflet, o uso do &lt;code&gt;django-leaflet&lt;/code&gt; nos permite definirmos as suas configura√ß√µes no &lt;code&gt;settings.py&lt;/code&gt; da &lt;code&gt;app&lt;/code&gt;, a partir da se√ß√£o &lt;code&gt;LEAFLET_CONFIG&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Dentre as &lt;a href=&#34;https://django-leaflet.readthedocs.io/en/latest/templates.html#configuration&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;configura√ß√µes poss√≠veis&lt;/a&gt;
, vou usar apenas o par de coordenadas ao qual o mapa dever√° estar centralizado por padr√£o (&lt;code&gt;DEFAULT_CENTER&lt;/code&gt;) e o zoom padr√£o (&lt;code&gt;DEFAULT_ZOOM&lt;/code&gt;):&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;LEAFLET_CONFIG = {
    &#39;DEFAULT_CENTER&#39;: (-22, -42),
    &#39;DEFAULT_ZOOM&#39;: 7,
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Com isso nosso mapa sempre ser√° apresentado centralizado nas coordenadas (-22, -42) e com o zoom 7:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;map_proj/img/leaflet_4.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Pronto: com esses tr√™s artigos, j√° temos um sistema com formul√°rio de inser√ß√£o de dados, com as devidas valida√ß√µes dos dados preenchidos no mesmo, assim como um &lt;em&gt;webmap&lt;/em&gt; apresentando-os ao mundo :-).&lt;/p&gt;
&lt;p&gt;Na pr√≥xima publica√ß√£o vamos ver como fazer o &lt;em&gt;deploy&lt;/em&gt; desse sistema no &lt;a href=&#34;https://www.heroku.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;heroku&lt;/a&gt; üöÄ.&lt;/p&gt;
&lt;p&gt;At√© l√°!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Bug buster</title>
      <link>/post/bug-buster/</link>
      <pubDate>Fri, 15 Apr 2022 00:00:00 +0000</pubDate>
      <guid>/post/bug-buster/</guid>
      <description>&lt;h3 id=&#34;como-tudo-come√ßou&#34;&gt;Como tudo come√ßou:&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;Nota do autor: artigo publiciado em 27/04/2022:&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Estou trabalhando num projeto onde uma das fun√ß√µes do python √© executada e recebe um um par√¢mtero pelo terminal. Um detalhe √© que esse par√¢metro √© o nome de uma pessoa. Um ponto que n√£o previ no processo de desenvolvimento √© que nomes, como qualquer outro elemento textual da lingua portuguesa, podem ter acentos (ou &amp;ldquo;caracteres especiais&amp;rdquo;).&lt;/p&gt;
&lt;p&gt;Pois √©, foi praticamente sem querer que vi, olhando os logs produzidos, que os nomes com acento estavam com problema de &lt;code&gt;encoding&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;E assim come√ßou a minha ca√ßa ao bug. Uma ca√ßa que me tomou um dia e meio. Mas foi de grande aprendizado.&lt;/p&gt;
&lt;h3 id=&#34;um-pouco-do-contexto&#34;&gt;Um pouco do contexto:&lt;/h3&gt;
&lt;p&gt;Antes de descrever essa aventura, comento um pouco o fluxo do programa que apresentou erro:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Uma fun√ß√£o √© executada pelo terminal e recebe um par√¢mtero, que √© o nome de uma pessoa;&lt;/li&gt;
&lt;li&gt;Esse nome √© usado para instanciar um objeto. Logo no &lt;code&gt;__init__&lt;/code&gt; tenho o ponto de acesso ao que foi informado pelo terminal com a incorpora√ß√£o do mesmo como atributo da inst√¢ncia.&lt;/li&gt;
&lt;li&gt;Alguns processamnetos, que n√£o vem ao caso, s√£o realizados;&lt;/li&gt;
&lt;li&gt;O log do processamento realizado √© persistirdo numa base de dados usando o &lt;code&gt;SQLAlchemy&lt;/code&gt;, onde a tabela que o recebe possui um campo id e outro json, com os logs organizados em tal formato.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;e-agora-por-onde-come√ßar&#34;&gt;E agora? Por onde come√ßar?&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Buscando o bug no terminal&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Como o par√¢metro estava sendo passado por terminal, achei que o problema estava nesse ponto: no terminal. Primeiro passo: checar o encoding usado pelo sistema. Mas logo vi que estava tudo em &lt;code&gt;utf-8&lt;/code&gt;, o que por s√≠, n√£o deveria apresentar problema.&lt;/p&gt;
&lt;p&gt;Como o nome estava sendo passado como um par√¢metro do sistema a partir de uma vari√°vel, aproveitei para checar se o erro n√£o estava a√≠. Nada que um print e alguns testes no terminal n√£o resolva.  E nada, os nomes armazenados na vari√°ve e passados como par√¢metro n√£o sofriam qualquer altera√ß√£o neste processo inicial.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Interse√ß√£o terminal/python&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Achei, ent√£o que o erro estava em alguma incompatibilidade entre o que era passado no terminal e o como o python estava recebendo.&lt;/p&gt;
&lt;p&gt;Segundo passo, ent√£o, foi checar o ponto de contato entre terminal e o python. Ler o seguinte trecho, de uma resposta do &lt;em&gt;stackOverFlow&lt;/em&gt; me deu a certeza de que era a√≠ o erro:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;When Python does not detect that it is printing to a terminal, sys.stdout.encoding is set to None.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Ou seja, quando o python n√£o pode detectar o que est√° sendo apresentado ao terminal o &lt;code&gt;sys.stdout.encoding&lt;/code&gt; √© definido como &lt;code&gt;None&lt;/code&gt;; Ora, estou passando um parametro a partir de uma vari√°vel do terminal, logo um string. O Python n√£o consegue identificar o encoding dessa string e est√° definindo, ent√£o o encoding a None, o que deve estar gerando o erro.&lt;/p&gt;
&lt;p&gt;Tentando resolver isso, busquei alguma forma de declarar o encoding&amp;hellip; Cheguei a adicionar ao &lt;code&gt;__init__&lt;/code&gt;, quando a classe √© instanciada e recebe o nome da pessoa os m√©todos, &lt;code&gt;.encode().decode(&#39;utf-8&#39;)&lt;/code&gt; ao objeto que recebe o valor. Parecia que ia funcionar, vejam:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;nome = &#39;Felipe Sodr√©&#39;
b&#39;Felipe Sodr\xc3\xa9&#39;
# e ao adicionar o decode o texto volta ao normal...
nome.encode().decode(&#39;utf-8&#39;)
&#39;Felipe Sodr√©&#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&amp;ldquo;Meio&amp;rdquo; gambiarra, n√£o? Mas o importante √© se funcionar.&lt;/p&gt;
&lt;p&gt;Contudo, o que parecia a solu√ß√£o, foi logo por agua abaixo na primeira rodada de teste. O nome continua com erro de encoding.&lt;/p&gt;
&lt;p&gt;Decid√≠, ent√£o, usar o m√≥dulo &lt;code&gt;logging&lt;/code&gt; para apresentar o nome recebido pelo terminal e nome ap√≥s a classe estar instanciada durante o processamento. Ali√°s, o &lt;a href=&#34;https://twitter.com/dunossauro&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;@dunosauro&lt;/a&gt; apresentou &lt;a href=&#34;https://www.youtube.com/watch?v=PGAOqAWuwC0&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;uma live&lt;/a&gt; muito boa sobre o uso do &lt;code&gt;logging&lt;/code&gt;&amp;hellip;&lt;/p&gt;
&lt;p&gt;Bom, ao usar o &lt;code&gt;logging&lt;/code&gt; tive certeza de que estava tentando resolver o erro no ponto errado, todas as mensagens de log estavam sem o tal erro de encoding, mas no log persistido no banco de dados seguia com o maldito erro&amp;hellip;&lt;/p&gt;
&lt;p&gt;Ser√° que o banco de dados est√° configurado com uma encoding diferente?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;No banco de dados&amp;hellip;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;‚úîÔ∏è Banco configurado como &amp;lsquo;utf-8&amp;rsquo;;&lt;/p&gt;
&lt;p&gt;At√© que me veio uma luz: nas mensagens de log o nome est√° sem erro. Mas o log que est√° sendo persistido no banco de dados ( que s√£o algumas dessas mensagens filtradas para monitorar alguns pontos importantes do sistema) √© uma compila√ß√£o salva em um campo JSON.&lt;/p&gt;
&lt;p&gt;&amp;ldquo;Bom deve ser nesse ponto, ent√£o.&amp;rdquo;, pensei.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Reproduzindo o erro em &lt;code&gt;JSON&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Parti ent√£o para tentar reproduzir esse erro:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt;&amp;gt;&amp;gt;import json
&amp;gt;&amp;gt;&amp;gt;info = {&#39;nome&#39;:&#39;Felipe Sodr√©&#39;, &#39;idade&#39;:38}
&amp;gt;&amp;gt;&amp;gt;info
{&#39;nome&#39;: &#39;Felipe Sodr√©&#39;, &#39;idade&#39;: 28}
&amp;gt;&amp;gt;&amp;gt;json.dumps(info)
&#39;{&amp;quot;nome&amp;quot;: &amp;quot;Felipe Sodr\xc3\xa9&amp;quot;, &amp;quot;idade&amp;quot;: 38}&#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Pronto! A√≠ est√° o problema. No processo de convers√£o do dicion√°rio ao JSON, h√° algum tipo de convers√£o que gera o erro de encoding.&lt;/p&gt;
&lt;p&gt;N√£o levei &amp;ldquo;muito tempo&amp;rdquo; (tempo √© relativo, n√©?) para encontrar que o m√©todo &lt;a href=&#34;https://docs.python.org/3/library/json.html#json.dumps&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;dumps()&lt;/code&gt;&lt;/a&gt; possui o par√¢metro &lt;code&gt;ensure_ascii&lt;/code&gt;, com valor padr√£o &lt;code&gt;True&lt;/code&gt;, que garante que as &lt;code&gt;strings&lt;/code&gt; do JSON que possuam caracteres n√£o-ASCII estejam com &lt;code&gt;scape&lt;/code&gt;.:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;If ensure_ascii is true (the default), the output is guaranteed to have all incoming non-ASCII characters escaped. If ensure_ascii is false, these characters will be output as-is.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Testei usando o &lt;code&gt;dumps()&lt;/code&gt; com &lt;code&gt;ensur_ascii=False&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt;&amp;gt;&amp;gt;json.dumps(info, ensure_ascii=False)
&#39;{&amp;quot;nome&amp;quot;: &amp;quot;Fl√°via Duarte Nascimento&amp;quot;, &amp;quot;idade&amp;quot;: 12}&#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Pronto, ponto de erro encontrado. Basta adicionar o par√¢metro apra False e tudo se resolveria.&lt;/p&gt;
&lt;p&gt;Mas n√£o foi bem assim, ainda faltava um ponto. Eu n√£o estava gerando o dump e salvando no banco. O que estou fazendo √© passar o dado, ainda em dicion√°rio, para o banco usando o &lt;em&gt;SQLAlchemy&lt;/em&gt; e ele cuida disso para mim.&lt;/p&gt;
&lt;p&gt;Como, ou melhor, onde, ent√£o, eu devo informar esse &lt;code&gt;ensure_ascii&lt;/code&gt;?&lt;/p&gt;
&lt;h3 id=&#34;enfim-a-solu√ß√£o&#34;&gt;Enfim, a solu√ß√£o:&lt;/h3&gt;
&lt;p&gt;Foi lendo &lt;a href=&#34;https://stackoverflow.com/a/36438671&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;essa responta no SOF&lt;/a&gt; que entend√≠ que como o ORM &lt;em&gt;SQLAlchemy&lt;/em&gt; est√° cuidadno disso para mim, ele possui um serializador e que o mesmo √©, nada mais, nada menos que os m√©todos &lt;code&gt;jason.dumps()&lt;/code&gt; e &lt;code&gt;json.loads()&lt;/code&gt;, passados na fun√ß√£o &lt;a href=&#34;https://docs.sqlalchemy.org/en/14/core/engines.html#sqlalchemy.create_engine&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;create_engine&lt;/code&gt;&lt;/a&gt; como um &lt;em&gt;kwargs&lt;/em&gt;:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;engine = create_engine(..., json_serializer=dumps)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;O golpe final foi ao ler a docuementa√ß√£o do  SQLAlchemy sobre &lt;a href=&#34;https://docs.sqlalchemy.org/en/14/core/type_basics.html#sqlalchemy.types.JSON&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;o tipo de dado JSON&lt;/a&gt; e aprender que podemos customizar o serializador. Olha s√≥ o exemplo da documenta√ß√£o, me dando de &amp;ldquo;bandeja&amp;rdquo; a solu√ß√£o para o bug em quest√£o:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;engine = create_engine(
    &amp;quot;sqlite://&amp;quot;,
    json_serializer=lambda obj: json.dumps(obj, ensure_ascii=False))
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Agora sim, vida que segue, gra√ßas √† persist·∫Ωncia e perseveran√ßa na ca√ßa aos bugs.&lt;/p&gt;
&lt;p&gt;Ah, claro. Essa investiga√ß√£o contou com a ajuda de outros colegas que dedicaram alguns minutos para conversar e propor solu√ß√µes, tab√©m. Muito obrigado!&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;nota do autor: artigo publiciado em 27/04/2022:&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Quando achei que estava tudo funcionando e coloquei em produ√ß√£o a corre√ß√£o, eis que me deparo com um novo erro. Dessa vez um &lt;code&gt;TypeError&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;raise TypeError(f&#39;Object of type {o.__class__.__name__} &#39;
sqlalchemy.exc.StatementError: (builtins.TypeError) Object of type datetime is not JSON serializable
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Com algumas pesquisas, pude identificar que, como estou indicando um serializador, Todo objeto a ser inluido no JSON passar√° por ele. Mas, como o pr√≥prio erro informa, um objeto &lt;code&gt;datetime&lt;/code&gt; n√£o pode ser seriaizado. E por isso que o m√©todo &lt;code&gt;json.dumps()&lt;/code&gt;, al√©m de ter o par√¢metro &lt;code&gt;ensure_ascii&lt;/code&gt;, possui um argumento para a serializa√ß√£o padr√£o.&lt;/p&gt;
&lt;p&gt;Portanto o √∫ltimo bug foi resolvido usando o par√¢metro &lt;code&gt;default=str&lt;/code&gt;. Ou seja, o serializador padr√£oa pe transformar o objeto a uma classe &lt;em&gt;string&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;O codigo ficou, ent√£o da seguinte forma:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;engine = create_engine(
    &amp;quot;sqlite://&amp;quot;,
    json_serializer=lambda obj: json.dumps(obj, ensure_ascii=False, default=str))
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;E voc√™s, que estrat√©gias adotam na ca√ßa aos bugs?&lt;/p&gt;
&lt;p&gt;Note: image from &lt;a href=&#34;https://www.mclibre.org/consultar/documentacion/listados/thepracticaldev.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;@ThePracticalDev&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Criando um sistema para gest√£o de dados geogr√°ficos de forma simples e robusta II</title>
      <link>/post/criando-um-sistema-para-gestao-de-dados-geograficos-de-forma-simples-e-robusta-ii/</link>
      <pubDate>Sun, 11 Jul 2021 00:00:00 +0000</pubDate>
      <guid>/post/criando-um-sistema-para-gestao-de-dados-geograficos-de-forma-simples-e-robusta-ii/</guid>
      <description>&lt;h1 id=&#34;criando-um-sistema-para-gest√£o-de-dados-geogr√°ficos-de-forma-simples-e-robusta-ii&#34;&gt;Criando um sistema para gest√£o de dados geogr√°ficos de forma simples e robusta II&lt;/h1&gt;
&lt;p&gt;&lt;em&gt;Artigo publicado tamb√©m no &lt;a href=&#34;https://www.linkedin.com/pulse/criando-um-sistema-para-gest%25C3%25A3o-de-dados-geogr%25C3%25A1ficos-e-felipe--1e&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;linkedin&lt;/strong&gt;&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Na &lt;a href=&#34;https://www.linkedin.com/pulse/criando-um-sistema-para-gest%C3%A3o-de-dados-geogr%C3%A1ficos-e-felipe-/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;primeira publica√ß√£o&lt;/a&gt; onde exploro a possibilidade de implementar um sistema de gest√£o de dados geoespaciais com Django, sem a necessidade de usar um servidor com PostGIS, vimos sobre:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;o &lt;a href=&#34;https://django-geojson.readthedocs.io/en/latest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;django-geojson&lt;/code&gt;&lt;/a&gt; para simular um campo geogr√°fico no models;&lt;/li&gt;
&lt;li&gt;o &lt;a href=&#34;https://geojson.readthedocs.io/en/latest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;geojson&lt;/code&gt;&lt;/a&gt; para criar um objeto da classe &lt;em&gt;geojson&lt;/em&gt; e realizar as valida√ß√µes necess√°rias para garantir robustez do sistema;&lt;/li&gt;
&lt;li&gt;a cria√ß√£o do formul√°rio de registro de dados usando o &lt;a href=&#34;https://docs.djangoproject.com/en/3.2/topics/forms/modelforms/#modelform&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;ModelForm&lt;/code&gt;&lt;/a&gt;;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Agora √© hora de evoluir e expandir um pouco o sistema criado. Nessa publica√ß√£o vamos criar validadores de longitude e latitude para poder restringir a inser√ß√£o de dados a uma determinada regi√£o. Com isso, o pr√≥ximo passo (e artigo) ser√° criar o &lt;em&gt;webmap&lt;/em&gt; no nosso sistema. Mas isso fica para breve.&lt;/p&gt;
&lt;p&gt;Vamos ao que interessa:&lt;/p&gt;
&lt;h2 id=&#34;criando-validadores-de-longitude-e-latitude&#34;&gt;Criando validadores de longitude e latitude&lt;/h2&gt;
&lt;h3 id=&#34;sobre-os-validadores&#34;&gt;Sobre os validadores:&lt;/h3&gt;
&lt;p&gt;Os validadores (&lt;a href=&#34;https://docs.djangoproject.com/en/3.2/ref/forms/validation/#validators&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;validators&lt;/code&gt;&lt;/a&gt;, em ingl√™s) fazem parte do sistema de valida√ß√£o de formul√°rios e de campos do Django. Ao criarmos campos de uma determinada classe no nosso modelo, como por exemplo &lt;em&gt;integer&lt;/em&gt;, o Django cuidar√° automaticamente da valida√ß√£o do valor passado a este campo pelo formul√°rio, retornando um erro quando o usu√°rio ingressar um valor de texto no campo em quest√£o, por exemplo. O interessante √© que al√©m dos validadores j√° implementados para cada classe, podemos criar outros, conforme a nossa necessidade.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Por que necessitamos um validador para os campos de &lt;code&gt;latitude&lt;/code&gt; e &lt;code&gt;longitude&lt;/code&gt;?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Como estou explorando o desenvolvimento de um sistema de gest√£o de dados geogr√°ficos com recursos limitados, ou seja, sem uma infraestrutura de opera√ß√µes e consultas espaciais, n√£o poderei consultar se o par de coordenadas inserido pelo usu√°rio est√° contido nos limites de um determinado estado (uma opera√ß√£o cl√°ssica com dados geogr√°ficos). N√£o ter essa possibilidade de valida√ß√£o poder√° colocar em risco a qualidade do dado inserido.&lt;/p&gt;
&lt;p&gt;E como n√£o se abre m√£o quando a quest√£o √© qualidade, uma sa√≠da ser√° a cria√ß√£o de validadores personalizados para os campos de &lt;code&gt;latitude&lt;/code&gt; e &lt;code&gt;longitude&lt;/code&gt;, garantindo que esses possuem valores condizentes √† nossa √°rea de interesse.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;O que precisamos saber:&lt;/strong&gt;
os &lt;code&gt;validators&lt;/code&gt; s√£o fun√ß√µes que recebem um valor, apenas (neste caso, o valor inserido pelo usu√°rio no campo a ser validado), que passar√° por uma l√≥gica de valida√ß√£o retornando um &lt;a href=&#34;https://docs.djangoproject.com/en/3.2/ref/forms/validation/#raising-validation-error&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;ValidationError&lt;/code&gt;&lt;/a&gt; quando o valor inserido n√£o passar na valida√ß√£o. Com o &lt;code&gt;ValidationError&lt;/code&gt; podemos customizar uma mensagem de erro, indicando ao usu√°rio o motivo do valor n√£o ter sido considerado v√°lido, para que o mesmo corrija.&lt;/p&gt;
&lt;p&gt;Ent√£o, criarei validadores dos campos de &lt;code&gt;latitude&lt;/code&gt; e &lt;code&gt;longitude&lt;/code&gt; para sempre que entrarem com valores que n√£o contemplem a √°rea do estado do Rio de Janeiro, um &lt;code&gt;ValidationError&lt;/code&gt; ser√° retornado.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;‚ö†Ô∏è Essa n√£o √© uma solu√ß√£o √≥tima j√° que, dessa forma, estamos considerando o &lt;em&gt;bounding box&lt;/em&gt; do estado em quest√£o, e com isso haver√° √°reas onde as coordenadas ser√£o v√°lidas, ainda que n√£o estejam internas ao territ√≥rio estadual. Ainda assim, acredito que seja uma solu√ß√£o boa suficiente para alguns casos, principalmente por n√£o depender de toda infraestrutura de GIS.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;O que √© um &lt;code&gt;bounding box&lt;/code&gt;?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Bounding box&lt;/em&gt; poderia ser traduzido por &amp;ldquo;ret√¢ngulo envolvente&amp;rdquo; do estado, ou de uma fei√ß√£o espacial. Na imagem abaixo, vemos o territ√≥rio do estado do Rio de Janeiro e o ret√¢ngulo envolvente que limita as suas coordenadas m√°ximas e m√≠nimas de longitude e latitude.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./img/RJ_bbox.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Percebam que, como mencionado antes, o que conseguimos garantir √© que os pares de coordenadas estejam em alguma √°rea interna ao ret√¢ngulo em quest√£o o que n√£o garante que as mesmas estejam no territ√≥rio do estado do Rio de Janeiro.&lt;/p&gt;
&lt;p&gt;Por uma quest√£o de organiza√ß√£o, criei no &lt;code&gt;settings.py&lt;/code&gt; do meu projeto  as vari√°veis com os valores m√°ximos e m√≠nimos de latitude e longitude. Essa proposta surgiu do &lt;a href=&#34;https://twitter.com/cuducos&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;cuducos&lt;/code&gt;&lt;/a&gt;, e achei que valia a pena implementar. Entendo que √© mais organizado e evita poss√≠veis falhas humanas, caso os mesmos valores tenham que ser usados em outras partes do sistema.&lt;/p&gt;
&lt;p&gt;Ao fim do meu &lt;code&gt;settings.py&lt;/code&gt;, adicionei:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# settings.py
BOUNDING_BOX_LAT_MAX = -20.764962
BOUNDING_BOX_LAT_MIN = -23.366868
BOUNDING_BOX_LON_MAX = -40.95975
BOUNDING_BOX_LON_MIN = -44.887212
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Agora, sim. Vamos criar os testes:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;se voc√™ n√£o entendeu o motivo pelo qual eu come√ßo criando testes, d√° uma olhada na &lt;a href=&#34;https://www.linkedin.com/pulse/criando-um-sistema-para-gest%C3%A3o-de-dados-geogr%C3%A1ficos-e-felipe-/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;primeira publica√ß√£o&lt;/a&gt;. Nela comento um pouco sobre a abordagem &lt;em&gt;Test Driven Development (TDD)&lt;/em&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;criando-os-testes&#34;&gt;Criando os testes:&lt;/h2&gt;
&lt;p&gt;No &lt;code&gt;tests.py&lt;/code&gt;, criei uma nova classe de teste &lt;code&gt;TestCase&lt;/code&gt;, com o objetivo de testar os validadores simulando o uso do &lt;code&gt;FenomenoForm&lt;/code&gt;. Por isso criei &lt;a href=&#34;https://realpython.com/instance-class-and-static-methods-demystified/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;staticmethod&lt;/code&gt;&lt;/a&gt; chamado &lt;code&gt;create_form&lt;/code&gt; que cria um dicion√°rio com chaves e valores v√°lidos do formul√°rio em quest√£o, que ao receber um conjunto de argumentos nomeados &lt;a href=&#34;https://realpython.com/python-kwargs-and-args/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;**kwargs&lt;/code&gt;&lt;/a&gt; ter√° tais argumentos atualizados e usados para instanciar e retornar o &lt;code&gt;FenomenoForm&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Fiz isso para, a cada teste, ter uma inst√¢ncia do &lt;code&gt;FenoenoForm&lt;/code&gt; alterando apenas os campos que quero simular valores a serem validados, sem ter que passar sempre todos os valores do &lt;code&gt;ModelForm&lt;/code&gt;. Assim, eu posso criar diferentes m√©todos de &lt;em&gt;Test Case&lt;/em&gt;, usando o m√©todo criado anteriormente alterando o valor inicial a um inv√°lido, testando se de fato um &lt;code&gt;ValidationError&lt;/code&gt; √© retornado.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# tests.py
class FenomenoFormValidatorsTest(TestCase):
    @staticmethod
    def create_form(**kwargs):
        valid_form = {
            &#39;nome&#39;: &#39;Teste&#39;,
            &#39;data&#39;: &#39;2020-01-01&#39;,
            &#39;hora&#39;: &#39;09:12:12&#39;,
            &#39;longitude&#39;: -42,
            &#39;latitude&#39;: -21}

        valid_form.update(**kwargs)
        form = FenomenoForm(valid_form)
        return form

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Nos m√©todos de teste uso primeiro o &lt;code&gt;assertFalse&lt;/code&gt; do m√©todo de valida√ß√£o do formul√°rio (&lt;code&gt;form.is_valid()&lt;/code&gt;) para confirmar que o mesmo n√£o √© valido para, em seguida, testar com o &lt;code&gt;assertEqual&lt;/code&gt; se o texto da mensagem de erro √© o que esperamos. Veja o link a seguir para saber sobre outros &lt;a href=&#34;https://docs.python.org/3/library/unittest.html#unittest.TestCase.debug&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;assertions&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# tests.py
    def test_max_longitude_raises_error(self):
        form = self.create_form(longitude=&#39;-45&#39;)
        self.assertFalse(form.is_valid())
        self.assertEqual(form.errors[&amp;quot;longitude&amp;quot;][0], &#39;Coordenada longitude fora do contexto do estado do Rio de Janeiro&#39;)

    def test_min_longitude_raises_error(self):
        form = self.create_form(longitude=&#39;-40&#39;)
        self.assertFalse(form.is_valid())
        self.assertEqual(form.errors[&amp;quot;longitude&amp;quot;][0], &#39;Coordenada longitude fora do contexto do estado do Rio de Janeiro&#39;)

    def test_max_latitude_raises_error(self):
        form = self.create_form(latitude=&#39;-24&#39;)
        self.assertFalse(form.is_valid())
        self.assertEqual(form.errors[&amp;quot;latitude&amp;quot;][0], &#39;Coordenada latitude fora do contexto do estado do Rio de Janeiro&#39;)

    def test_min_latitude_raises_error(self):
        form = self.create_form(latitude=&#39;-19&#39;)
        self.assertFalse(form.is_valid())
        self.assertEqual(form.errors[&amp;quot;latitude&amp;quot;][0], &#39;Coordenada latitude fora do contexto do estado do Rio de Janeiro&#39;)

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Fazemos rodar os testes e teremos erros como esses:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;Creating test database for alias &#39;default&#39;...
System check identified no issues (0 silenced).
...E.E..
======================================================================
ERROR: test_max_latitude (map_proj.core.tests.FenomenoFormValidatorsTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &amp;quot;/media/felipe/DATA/Repos/Django_Leaflet_Test/map_proj/core/tests.py&amp;quot;, line 78, in test_max_latitude
    self.assertEqual(form.errors[&amp;quot;latitude&amp;quot;][0], &#39;Coordenada latitude fora do contexto do estado do Rio de Janeiro&#39;)
KeyError: &#39;latitude&#39;

======================================================================
ERROR: test_min_latitude (map_proj.core.tests.FenomenoFormValidatorsTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &amp;quot;/media/felipe/DATA/Repos/Django_Leaflet_Test/map_proj/core/tests.py&amp;quot;, line 83, in test_min_latitude
    self.assertEqual(form.errors[&amp;quot;latitude&amp;quot;][0], &#39;Coordenada latitude fora do contexto do estado do Rio de Janeiro&#39;)
KeyError: &#39;latitude&#39;

----------------------------------------------------------------------
Ran 8 tests in 0.012s

FAILED (errors=2)
Destroying test database for alias &#39;default&#39;...

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Ou seja, o &lt;code&gt;forms&lt;/code&gt; ap√≥s ser validado deveria conter um atributo &lt;em&gt;errors&lt;/em&gt; tendo como chave o nome do campo que apresentou dados inv√°lidos. Como n√£o temos os validadores criados, nenhum erro de valida√ß√£o foi acusado no campo de &lt;code&gt;latitude&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;criando-e-usando-validadores&#34;&gt;Criando e usando validadores:&lt;/h2&gt;
&lt;p&gt;Para super√°-los criamos, enfim, os validadores em um arquivo &lt;code&gt;validators.py&lt;/code&gt;. Percebam que √© nesse ponto que usarei os valores m√°ximos e m√≠nimos de latitude e longitude adicionados no &lt;code&gt;settings.py&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# validators.py
from django.core.exceptions import ValidationError
from django.conf import settings


def validate_longitude(lon):
    if lon &amp;lt; settings.BOUNDING_BOX_LON_MIN or lon &amp;gt; settings.BOUNDING_BOX_LON_MAX:
        raise ValidationError(&amp;quot;Coordenada longitude fora do contexto do estado do Rio de Janeiro&amp;quot;, &amp;quot;erro longitude&amp;quot;)

def validate_latitude(lat):
    if lat &amp;lt; settings.BOUNDING_BOX_LAT_MIN or lat &amp;gt; settings.BOUNDING_BOX_LAT_MAX:
        raise ValidationError(&amp;quot;Coordenada latitude fora do contexto do estado do Rio de Janeiro&amp;quot;, &amp;quot;erro latitude&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Com esses validadores estou garantindo que ambos latitude e longitude estejam na √°rea de interesse e, caso contr√°rio, retorno um erro informando ao usu√°rio.&lt;/p&gt;
&lt;p&gt;E √© preciso adicion√°-los ao &lt;code&gt;forms.py&lt;/code&gt; para que sejam usados:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# forms.py
from map_proj.core.validators import validate_longitude, validate_latitude

class FenomenoForm(ModelForm):
    longitude = FloatField(validators=[validate_longitude])
    latitude = FloatField(validators=[validate_latitude])
...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;No desenvolvimento dessa solu√ß√£o percebi pelos testes criados que, ao informar uma latitude ou longitude que n√£o passe pela valida√ß√£o, a cria√ß√£o do campo &lt;code&gt;geom&lt;/code&gt; se tornava inv√°lido por n√£o receber um desses valores, gerando dois erros: o de valida√ß√£o do campo e o de valida√ß√£o do campo &lt;code&gt;geom&lt;/code&gt;. Lembre-se que √© no m√©todo &lt;code&gt;clean&lt;/code&gt; do formul√°rio que o campo &lt;code&gt;geom&lt;/code&gt; recebe os valores de &lt;code&gt;longitude&lt;/code&gt; e &lt;code&gt;latitude&lt;/code&gt; formando uma classe &lt;code&gt;geojson&lt;/code&gt; para, logo em seguida ser validado.&lt;/p&gt;
&lt;p&gt;Para evitar isso, alterei o m√©todo clean de forma garantir que o campo &lt;code&gt;geom&lt;/code&gt; s√≥ seja criado e validado, quando ambos valores (&lt;code&gt;longitude&lt;/code&gt; e &lt;code&gt;latitude&lt;/code&gt;) existirem. Ou seja, tenham passado pelos validadores sem erro.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#forms.py
    def clean(self):
        cleaned_data = super().clean()
        lon = cleaned_data.get(&#39;longitude&#39;)
        lat = cleaned_data.get(&#39;latitude&#39;)
        if not all((lon, lat)):
            raise ValidationError(&#39;Erro em latitude ou longitude&#39;)
        
        cleaned_data[&#39;geom&#39;] = Point((lon, lat))
        if not cleaned_data[&#39;geom&#39;].is_valid:
                raise ValidationError(&#39;Geometria inv√°lida&#39;)
        
        return cleaned_data

&lt;/code&gt;&lt;/pre&gt;
&lt;blockquote&gt;
&lt;p&gt;Outro ponto (na verdade, erro) importante que s√≥ percebi a partir dos testes √© que no &lt;code&gt;forms.py&lt;/code&gt; eu n√£o estava considerando o campo &lt;code&gt;geom&lt;/code&gt; na lista de &lt;code&gt;fields&lt;/code&gt; a serem usados. Com isso o mesmo n√£o √© passado ao banco de dados, mesmo passando pelo m√©todo &lt;code&gt;clean&lt;/code&gt; que o cria.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Por esse motivo, tive que alterar algumas coisas no &lt;code&gt;forms.py&lt;/code&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Inseri o campo &lt;code&gt;geom&lt;/code&gt; √† tupla de &lt;code&gt;fields&lt;/code&gt; do &lt;code&gt;forms.py&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Inseri o campo &lt;code&gt;geom&lt;/code&gt; com um widget de &lt;code&gt;HiddenInput&lt;/code&gt;. Esse √∫ltimo, o fiz por se tratar de um campo que n√£o quero expor ao usu√°rio, j√° que ser√° criado automaticamente no m√©todo &lt;code&gt;clean&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Finalmente, a classe &lt;code&gt;Meta&lt;/code&gt; do &lt;code&gt;forms.py&lt;/code&gt; ficou da seguinte forma:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;    class Meta:
        model = Fenomeno
        fields = (&#39;nome&#39;, &#39;data&#39;, &#39;hora&#39;, &#39;latitude&#39;, &#39;longitude&#39;, &#39;geom&#39;)
        widgets = {&#39;geom&#39;: HiddenInput()}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Pronto, com tudo isso que fizemos, j√° temos um sistema que, apesar de n√£o poder fazer consultas espaciais, √© capaz de validar os campos de &lt;code&gt;latitude&lt;/code&gt; e &lt;code&gt;longitude&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;No pr√≥ximo artigo, vou abordar sobre o que est√° por tr√°s de toda m√°gica de um webmap, usando o m√≥dulo &lt;a href=&#34;https://django-leaflet.readthedocs.io/en/latest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;django-leaflet&lt;/code&gt;&lt;/a&gt;. Enquanto isso, d√™ uma olhada &lt;a href=&#34;http://felipesbarros.github.io&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;no que tenho desenvolvido.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Artigo publicado tamb√©m no &lt;a href=&#34;https://www.linkedin.com/pulse/criando-um-sistema-para-gest%25C3%25A3o-de-dados-geogr%25C3%25A1ficos-e-felipe--1e&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;linkedin&lt;/strong&gt;&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Criando um sistema para gest√£o de dados geogr√°ficos de forma simples e robusta</title>
      <link>/post/criando-um-sistema-para-gestao-de-dados-geograficos-de-forma-simples-e-robusta/</link>
      <pubDate>Fri, 07 May 2021 00:00:00 +0000</pubDate>
      <guid>/post/criando-um-sistema-para-gestao-de-dados-geograficos-de-forma-simples-e-robusta/</guid>
      <description>&lt;h1 id=&#34;criando-um-sistema-para-gest√£o-de-dados-geogr√°ficos-de-forma-simples-e-robusta&#34;&gt;Criando um sistema para gest√£o de dados geogr√°ficos de forma simples e robusta&lt;/h1&gt;
&lt;p&gt;&lt;em&gt;Artigo publicado tamb√©m no &lt;a href=&#34;https://www.linkedin.com/pulse/criando-um-sistema-para-gest%C3%A3o-de-dados-geogr%C3%A1ficos-e-felipe-/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;linkedin&lt;/strong&gt;&lt;/a&gt;&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;H√° algum tempo comecei a estudar sobre desenvolvimento de sistema com Python, usando a framework Django. Decidi expor alguns aprendizados em uma serie de artigos. A ideia √© que esses textos me ajudem na consolida√ß√£o do conhecimento e, ao t√™-los publicado, ajudar a outros que tenham interesse na √°rea.&lt;/p&gt;
&lt;p&gt;Aproveito para deixar meu agradecimento ao Cuducos que, tanto neste artigo, como em todos meus estudos tem sido um grande mentor. Vamos ao que interessa:&lt;/p&gt;
&lt;p&gt;Por simples, entende-se:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Um sistema sem a necessidade da instala√ß√£o e configura√ß√£o de base de dados PostgreSQL/GIS, Geoserver, etc;&lt;/li&gt;
&lt;li&gt;Um sistema cl√°ssico tipo &lt;em&gt;Create&lt;/em&gt;, &lt;em&gt;Retrieve&lt;/em&gt;, &lt;em&gt;Update&lt;/em&gt;, &lt;em&gt;Delete&lt;/em&gt; (CRUD) para dados geogr√°ficos;&lt;/li&gt;
&lt;li&gt;Um sistema que n√£o demande opera√ß√µes e consultas espaciais;&lt;/li&gt;
&lt;li&gt;Mas um sistema que garanta a qualidade na gest√£o dos dados geogr√°ficos;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;vis√£o-geral-da-proposta&#34;&gt;Vis√£o geral da proposta:&lt;/h3&gt;
&lt;p&gt;Vamos criar um ambiente virtual Python e instalar a framework Django, para criar o sistema, assim como alguns m√≥dulos como &lt;a href=&#34;https://pypi.org/project/jsonfield/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;jsonfield&lt;/code&gt;&lt;/a&gt;, que nos vai habilitar a cria√ß√£o de campos &lt;code&gt;JSON&lt;/code&gt; em nossa base de dados; &lt;a href=&#34;https://pypi.org/project/django-geojson/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;django-geojson&lt;/code&gt;&lt;/a&gt;, que depende do &lt;code&gt;jsonfield&lt;/code&gt; e ser√° respons√°vel por habilitar inst√¢ncias de dados geogr√°ficos, baseando-se em &lt;code&gt;JSON&lt;/code&gt;; &lt;a href=&#34;https://pypi.org/project/geojson/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;geojson&lt;/code&gt;&lt;/a&gt;, que possui todas as regras &lt;em&gt;b√°sicas&lt;/em&gt; de valida√ß√£o de dados geogr√°ficos, usando a estrutura hom√¥nima, &lt;a href=&#34;https://geojson.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;geojson&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;O uso desses tr√™s m√≥dulos nos permitir√° o desenvolvimento de um sistema de gest√£o de dados geogr√°ficos sem a necessidade de termos instalado um sistema de gerenciamento de dados geogr√°ficos, como o PostGIS. Sim, nosso sistema ser√° bem limitado a algumas tarefas. Mas em contrapartida, poderemos desenvolv√™-lo e implementar solu√ß√µes &amp;ldquo;corriqueiras&amp;rdquo; de forma facilitada.&lt;/p&gt;
&lt;p&gt;No presente exemplo estarei usando &lt;a href=&#34;https://www.sqlite.org/index.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SQLite&lt;/a&gt;, como base de dados.&lt;/p&gt;
&lt;p&gt;Nosso projeto se chamar√° de &lt;em&gt;map_proj&lt;/em&gt;. E nele vou criar uma app, dentro da pasta do meu projeto &lt;code&gt;Django&lt;/code&gt;, chamada &lt;code&gt;core&lt;/code&gt;. Essa organiza√ß√£o e nomenclatura usada, vem das sugest√µes do &lt;a href=&#34;https://github.com/okfn-brasil/jarbas/issues/28#issuecomment-256117262&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Henrique Bastos&lt;/a&gt;. Afinal, o sistema est√° nascendo. Ainda que eu tenha uma ideia do que ele ser√°, √© interessante iniciar com uma aplica√ß√£o &amp;ldquo;gen√©rica&amp;rdquo; e a partir do momento que o sistema se torne complexo, poderemos desacopl√°-la em diferentes aplica√ß√µes.&lt;/p&gt;
&lt;h3 id=&#34;criando-ambiente-de-desenvolvimento-projeto-e-nossa-app&#34;&gt;Criando ambiente de desenvolvimento, projeto e nossa app:&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;python -m venv .djleaflet # cria ambiente virtual python
# ativando o ambiente virtual:
source ./venv/bin/activate

# atualizando o pip
pip install --upgrade pip

# intalando os m√≥dulos a serem usados
pip install django jsonfield django-geojson geojson

# criando projeto
django-admin startproject map_proj .

# criando app dentro do projeto
cd map_proj
python manage.py startapp core

# criando a base de dados inicial
python manage.py migrate 

# criando superusu√°rio
python manage.py createsuperuser 
&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&#34;adicionando-os-m√≥dulos-e-a-app-ao-projeto&#34;&gt;Adicionando os m√≥dulos e a app ao projeto&lt;/h4&gt;
&lt;p&gt;Agora √© adicionar ao &lt;code&gt;map_proj/settings.py&lt;/code&gt;, a app criada e os m√≥dulos que usaremos.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# setting.py
INSTALLED_APPS = [
    ...
    &#39;djgeojson&#39;,
    &#39;map_proj.core&#39;,
]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Perceba que para poder acessar as classes de alto n√≠vel criadas pelo pacote &lt;code&gt;djgeojson&lt;/code&gt;, teremos que adicion√°-lo ao &lt;code&gt;INSTALLED_APPS&lt;/code&gt; do &lt;code&gt;settings.py&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&#34;criando-a-base-de-dados&#34;&gt;Criando a base de dados&lt;/h3&gt;
&lt;p&gt;Ainda que eu concorde com o Henrique Bastos, que a vis√£o de come√ßar os projetos Django pelo &lt;code&gt;models.py&lt;/code&gt; √© um tanto &amp;ldquo;perigosa&amp;rdquo;, por colocar √™nfase em uma parte da app e, em muitos casos, negligenciar v√°rios outros atributos e ferramentas que o Django nos oferece, irei desconsiderar sua abordagem. Afinal, o objetivo deste artigo n√£o √© explorar todo o potencial do Django, mas sim apresentar uma solu√ß√£o simples no desenvolvimento e implementa√ß√£o de um sistema de gest√£o de dados geogr√°ficos para servir como ferramenta de estudo e projeto pr√°tico.&lt;/p&gt;
&lt;p&gt;Em &lt;code&gt;models.py&lt;/code&gt; usaremos inst√¢ncias de alto n√≠vel que o Django nos brinda para criar e configurar os campos e as tabelas que teremos em nosso sistema, bem como alguns comportamentos do sistema.&lt;/p&gt;
&lt;p&gt;Como estou desenvolvendo um sistema multi prop√≥sito, vou tentar mant√™-lo bem gen√©rico. A ideia √© que voc√™s possam imaginar o que adequar para um sistema especialista na sua √°rea de interesse. Vou criar, ent√£o, uma tabela para mapear &amp;ldquo;fen√¥menos&amp;rdquo; (quaisquer). Esse modelo ter√° os campos &lt;em&gt;nome&lt;/em&gt;, &lt;em&gt;data&lt;/em&gt;, &lt;em&gt;hora&lt;/em&gt; e &lt;em&gt;geometria&lt;/em&gt;, a qual ser√° uma inst√¢ncia de &lt;code&gt;PointField&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;O &lt;code&gt;PointField&lt;/code&gt; √© uma classe criada pelo &lt;code&gt;djgeojson&lt;/code&gt; que nos permite usar um campo para dados geogr√°ficos sem ter toda a infraestrutura do PostGIS, instalada, por exemplo. Nesse caso, estou simulando um campo de ponto, mas, de acordo com a documenta√ß√£o do pacote, todas as geometrias usadas em dados espaciais s√£o suportadas:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;All geometry types are supported and respectively validated : GeometryField, PointField, MultiPointField, LineStringField, MultiLineStringField, PolygonField, MultiPolygonField, GeometryCollectionField. ( &lt;a href=&#34;https://django-geojson.readthedocs.io/en/latest/models.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;djgeojson&lt;/code&gt;&lt;/a&gt; )&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# models.py
from django.db import models
from djgeojson.fields import PointField


class Fenomeno(models.Model):
    nome = models.CharField(max_length=100,
                            verbose_name=&#39;Fenomeno mapeado&#39;)
    data = models.DateField(verbose_name=&#39;Data da observa√ß√£o&#39;)
    hora = models.TimeField()
    geom = PointField(blank=True)

    def __str__(self):
        return self.nome

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Percebam que eu importo de &lt;code&gt;djgeojson&lt;/code&gt; a classe &lt;code&gt;PointField&lt;/code&gt;. O que o &lt;code&gt;django-geojson&lt;/code&gt; fez foi criar uma classe [com estrutura de dados geogr√°fico] de alto n√≠vel, mas que no banco de dados ser√° armazenado em um campo &lt;code&gt;JSON&lt;/code&gt;. Vale a pena deixar claro: n√£o espero que o usu√°rio do meu sistema saiba preencher o campo &lt;code&gt;geom&lt;/code&gt; em formato &lt;code&gt;JSON&lt;/code&gt;. Por isso, criarei no &lt;code&gt;forms.py&lt;/code&gt;, os campos &lt;em&gt;latitude&lt;/em&gt; e &lt;em&gt;longitude&lt;/em&gt; e a partir deles, o campo geom ser√° preenchido. Detalharei esse processo mais adiante.&lt;/p&gt;
&lt;p&gt;Pronto, j√° temos o modelo da &amp;lsquo;tabela de dados &amp;ldquo;geogr√°ficos&amp;rdquo;&amp;rsquo;, mas esse modelo ainda n√£o foi registrado em nossa base. Para isso:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;python manage.py makemigrations
python manage.py migrate
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;O &lt;code&gt;makemigrations&lt;/code&gt; analisa o &lt;code&gt;models.py&lt;/code&gt; e o compara com a vers√£o anterior identificando as altera√ß√µes e criando um arquivo que ser√° executado pelo &lt;code&gt;migrate&lt;/code&gt;, aplicando tais altera√ß√µes ao banco de dados. Aprendi com o Henrique Bastos e &lt;a href=&#34;https://twitter.com/cuducos&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Cuducos&lt;/a&gt; que o migrate √© um sistema de versionamento da estrutura do banco de dados, permitindo retroceder, quando necess√°rio, a outras vers√µes.&lt;/p&gt;
&lt;h3 id=&#34;criando-o-formul√°rio&#34;&gt;Criando o formul√°rio&lt;/h3&gt;
&lt;p&gt;Vou aproveitar algumas &amp;ldquo;pilhas j√° inclu√≠das&amp;rdquo; do Django, ao usar o &lt;code&gt;ModelForm&lt;/code&gt; para criar o formul√°rio para o carregamento de dados. O &lt;code&gt;ModelForm&lt;/code&gt; facilita esse processo.&lt;/p&gt;
&lt;p&gt;Ali√°s, √© importante pensar que os formul√°rios do Django v√£o muito al√©m da &amp;ldquo;carga de dados&amp;rdquo;, j√° que s√£o os respons√°veis por cuidar da intera√ß√£o com o usu√°rio e o(s) processo(s) de valida√ß√£o e limpeza dos dados preenchidos.&lt;/p&gt;
&lt;p&gt;Digo isso, pois ao meu &lt;code&gt;FenomenosForm&lt;/code&gt;, eu sobreescrevo o m√©todo &lt;code&gt;clean()&lt;/code&gt;, que cuida da valida√ß√£o e limpeza do formul√°rio e incluo nele:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;a constru√ß√£o dos dados do campo &lt;code&gt;geom&lt;/code&gt; a partir dos valores dos campos de &lt;em&gt;latitude&lt;/em&gt; e &lt;em&gt;longitude&lt;/em&gt; (criados exclusivamente para a ger√ß√£o do campo geom);&lt;/li&gt;
&lt;li&gt;a valida√ß√£o do campo geom;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# forms.py
from django.core.exceptions import ValidationError
from django.forms import ModelForm, FloatField
from map_proj.core.models import Fenomeno
from geojson import Point


class FenomenoForm(ModelForm):
    longitude = FloatField()
    latitude = FloatField()
    class Meta:
        model = Fenomeno
        fields = (&#39;nome&#39;, &#39;data&#39;, &#39;hora&#39;, &#39;latitude&#39;, &#39;longitude&#39;)

    def clean(self):
        cleaned_data = super().clean()
        lon = cleaned_data.get(&#39;longitude&#39;)
        lat = cleaned_data.get(&#39;latitude&#39;)
        cleaned_data[&#39;geom&#39;] = Point((lon, lat))

        if not cleaned_data[&#39;geom&#39;].is_valid:
            raise ValidationError(&#39;Geometria inv√°lida&#39;)
        return cleaned_data

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Ainda que pare√ßa simples, n√£o foi f√°cil chegar a essa estrat√©gia de estrutura√ß√£o dos &lt;code&gt;models&lt;/code&gt; e &lt;code&gt;forms&lt;/code&gt;. Contei com a ajuda e paciencia do &lt;a href=&#34;https://twitter.com/cuducos&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Cuducos&lt;/a&gt;. Inicialmente eu mantinha latitude e longitude no meu &lt;code&gt;models&lt;/code&gt;. Mas fazendo assim, al√©m de ter uma redund√¢ncia de dados e uma abertura a erros potenciais, estaria armazenando dados que n√£o devo usar depois de contruir o campo geom. Uma alternativa, discutida com o Cuducos foi de ter tanto &lt;em&gt;latitude&lt;/em&gt; como &lt;em&gt;longitude&lt;/em&gt; no &lt;code&gt;models&lt;/code&gt;, mas o atributo &lt;code&gt;geom&lt;/code&gt; como &lt;a href=&#34;https://docs.python.org/3/howto/descriptor.html#properties&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;propriedade&lt;/a&gt;. Ainda que seja uma estrat√©gia consistente, a redund√¢ncia se mant√©m.&lt;/p&gt;
&lt;p&gt;O processo de valida√ß√£o do campo &lt;code&gt;geom&lt;/code&gt; tamb√©m foi fruto de muita discuss√£o. De forma resumida, percebi que o &lt;code&gt;djgeojson&lt;/code&gt; apenas valida o tipo de geometria do campo e n√£o a sua consist√™ncia. Ao conversar com os desenvolvedores, me disseram que toda a l√≥gica de valida√ß√£o de objetos &lt;code&gt;geojson&lt;/code&gt; estavam sendo centralizados no m√≥dulo hom√¥nimo.&lt;/p&gt;
&lt;p&gt;Por isso eu carrego a classe &lt;code&gt;Point&lt;/code&gt; do m√≥dulo &lt;code&gt;geojson&lt;/code&gt; e designo o campo &lt;code&gt;geom&lt;/code&gt; como inst√¢ncia dessa classe. Assim, passo a poder contar com um processo de valida√ß√£o mais consistente, como o m√©todo &lt;code&gt;is_valid&lt;/code&gt;, usado anteriormente.&lt;/p&gt;
&lt;h4 id=&#34;mas-e-o-teste&#34;&gt;Mas e o teste?&lt;/h4&gt;
&lt;p&gt;Pois √©, eu adoraria apresentar isso usando a abordagem &lt;em&gt;Test Driven Development (TDD)&lt;/em&gt;. Mas, talvez pela falta de pr√°tica, conhecimento e etc, vou apenas apontar onde e como eu testaria esse sistema. Fa√ßo isso como uma forma de estudo, mesmo. Tamb√©m me pareceu complicado apresentar a abordagem TDD em um artigo, j√° que a mesma se faz de forma incremental.&lt;/p&gt;
&lt;h5 id=&#34;sobre-tdd&#34;&gt;Sobre TDD&lt;/h5&gt;
&lt;p&gt;Com o Henrique Bastos e toda a comunidade do &lt;a href=&#34;https://medium.com/welcome-to-the-django/o-wttd-%C3%A9-tudo-que-eu-ensinaria-sobre-prop%C3%B3sito-de-vida-para-mim-mesmo-se-pudesse-voltar-no-tempo-d73e516f911c&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;em&gt;Welcome to The Django&lt;/em&gt;&lt;/a&gt; vi que essa abordagem √© tanto filos√≥fica quanto t√©cnica. √â praticamente &amp;ldquo;Chora agora, ri depois&amp;rdquo;, mas sem a parte de chorar. Pois com o tempo as coisas ficam mais claras&amp;hellip; Alguns pontos:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;O erro n√£o √© para ser evitado no processo de desenvolvimento, mas sim quando estive em produ√ß√£o. Logo,&lt;/li&gt;
&lt;li&gt;Entenda o que voc√™ quer do sistema, crie um teste antes de implementar e deixe o erro te guiar at√© ter o que deseja;&lt;/li&gt;
&lt;li&gt;Teste o comportamento esperado e n√£o cada elemento do sistema;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Sem mais delongas:&lt;/p&gt;
&lt;h5 id=&#34;o-que-testar&#34;&gt;O que testar?&lt;/h5&gt;
&lt;p&gt;Vamos usar o arquivo &lt;code&gt;tests.py&lt;/code&gt; e  criar nossos testes l√°.
Ao abrir voc√™s v√£o ver que j√° est√° o comando importando o &lt;code&gt;TestCase&lt;/code&gt;.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Mas o que vamos testar?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Como pretendo testar tanto a estrutura da minha base de dados, quanto o formul√°rio e, de quebra, a valida√ß√£o do meu campo &lt;code&gt;geom&lt;/code&gt;, fa√ßo o &lt;code&gt;import&lt;/code&gt; do modelo &lt;code&gt;Fenomenos&lt;/code&gt; e do form &lt;code&gt;FenomenosForm&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;‚ö†Ô∏è Essa n√£o √© uma boa pr√°tica. O ideal √© criar uma pasta para os testes e separ√°-los em arquivos distintos. Um para cada elemento do sistema (model, form, view, etc).&lt;/p&gt;
&lt;p&gt;O primeiro teste ser√° a carga de dados. Ent√£o, vou instanciar um objeto com o resultado da cria√ß√£o de um elemento do meu &lt;code&gt;model&lt;/code&gt; &lt;code&gt;Fenomeno&lt;/code&gt;. Fa√ßo isso no &lt;code&gt;setUp&lt;/code&gt;, para n√£o ter que cri√°-lo sempre que for fazer um teste relacionado √† carga de dados.&lt;/p&gt;
&lt;p&gt;O teste seguinte ser√° relacionado ao formul√°rio e por isso instancio um formul√°rio com os dados carregados e testo a sua validez. Ao fazer isso o formul√°rio passa pelo processo de limpeza, onde est√° a constru√ß√£o e valida√ß√£o do campo &lt;code&gt;geom&lt;/code&gt;. Se qualquer campo for preenchido com dados errados ou inadequados, o django retornar√° &lt;code&gt;False&lt;/code&gt; ao m√©todo &lt;code&gt;is_valid&lt;/code&gt;. Ou seja, se eu tiver construido o campo &lt;code&gt;geom&lt;/code&gt; de forma equivocada, passando mais ou menos par√¢metros que o esperado o nosso teste ir√° avisar, evitando surpresas.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# tests.py
from django.test import TestCase
from geojson import Point

from map_proj.core.models import Fenomeno
from map_proj.core.forms import FenomenoForm


class ModelGeomTest(TestCase):
    def setUp(self):
        self.fenomeno = Fenomeno.objects.create(
            nome=&#39;Arvore&#39;,
            data=&#39;2020-11-06&#39;,
            hora=&#39;09:30:00&#39;
        )

    def test_create(self):
        self.assertTrue(Fenomeno.objects.exists())


class FenomenoFormTest(TestCase):
    def setUp(self):
        self.form = FenomenoForm({
            &#39;nome&#39;: &#39;Teste&#39;,
            &#39;data&#39;: &#39;2020-01-01&#39;,
            &#39;hora&#39;: &#39;09:12:12&#39;,
            &#39;longitude&#39;: -45,
            &#39;latitude&#39;: -22})
        self.validation = self.form.is_valid()

    def test_form_is_valid(self):
        &amp;quot;&amp;quot;&amp;quot;&amp;quot;form must be valid&amp;quot;&amp;quot;&amp;quot;
        self.assertTrue(self.validation)

    def test_geom_coordinates(self):
        &amp;quot;&amp;quot;&amp;quot;after validating, geom have same values of longitude and latitude&amp;quot;&amp;quot;&amp;quot;
        self.assertEqual(self.form.cleaned_data[&#39;geom&#39;], Point(
            (self.form.cleaned_data[&#39;longitude&#39;],
        self.form.cleaned_data[&#39;latitude&#39;])))

    def test_geom_is_valid(self):
        &amp;quot;&amp;quot;&amp;quot;geom must be valid&amp;quot;&amp;quot;&amp;quot;
        self.assertTrue(self.form.cleaned_data[&#39;geom&#39;].is_valid)

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;‚ö†Ô∏è Reparem que:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;No &lt;code&gt;test_create()&lt;/code&gt; eu testo se existem objetos inseridos no model &lt;code&gt;Fenomeno&lt;/code&gt;. Logo, testo se o dado criado no &lt;code&gt;setUp&lt;/code&gt; foi corretamente incorporado no banco de dados.&lt;/li&gt;
&lt;li&gt;Na classe &lt;code&gt;FenomenosFormTest&lt;/code&gt; eu crio uma inst√¢ncia do meu modelForm e realizo tr√™s testes:
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;test_form_is_valid()&lt;/code&gt; estou testando se os dados carregados s√£o condizentes com o informado no model e, pelo fato desse m√©todo usar o m√©todo &lt;code&gt;clean()&lt;/code&gt;, posso dizer que estou testando indiretamente a validez do campo &lt;code&gt;geom&lt;/code&gt;. Caso ele n√£o fosse v√°lido, o form tamb√©m n√£o seria v√°lido.&lt;/li&gt;
&lt;li&gt;Em &lt;code&gt;test_geom_coordinates()&lt;/code&gt; testo se ap√≥s a valida√ß√£o o campo geom foi criado como esperado (como uma inst√¢ncia de Point com os dalores de longitude e latitude).&lt;/li&gt;
&lt;li&gt;O teste &lt;code&gt;test_geom_is_valid()&lt;/code&gt; serve para garantir que a contru√ß√£o do campo geom √© valido. Ainda que ao testar se o formul√°rio √© valido eu estaria implicitamente testando a validez do campo geom, esse teste serve para garantir a cria√ß√£o v√°lida do campo. Afinal, por algum motivo (como por exemplo, refatora√ß√£o), pode ser que fa√ßamos alguma altera√ß√£o no m√©todo &lt;code&gt;clean()&lt;/code&gt; que mantenha o formul√°rio como v√°lido mas deixe de garantir a validez do campo geom.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;A diferen√ßa entre as classes de teste criadas est√° no fato de ao inserir os dados usando o m√©todo &lt;code&gt;create()&lt;/code&gt; - e aconteceria o mesmo se estivesse usando o &lt;code&gt;save()&lt;/code&gt; -, apenas ser√° validado se o elemento a ser inserido √© condizente com o tipo de coluna no banco de dados. Vale deixar claro: Dessa forma, eu n√£o estou validando a consist√™ncia do campo &lt;code&gt;geom&lt;/code&gt;, j√° que o mesmo, caso seja informado, ser√° salvo com sucesso sempre que represente um &lt;code&gt;JSON&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Esse fato √© importante para refor√ßar o entendimento de que o &lt;code&gt;djgeojson&lt;/code&gt; implementa classes de alto n√≠vel a serem trabalhados em &lt;code&gt;views&lt;/code&gt; e &lt;code&gt;models&lt;/code&gt;. No banco, mesmo, temos um campo de &lt;code&gt;JSON&lt;/code&gt;.
Enquanto que, para poder validar a consist√™ncia do campo &lt;code&gt;geom&lt;/code&gt;, preciso passar os dados pelo formul√°rio onde, no processo de limpeza do mesmo, o campo ser√° criado e validado usando o m√≥dulo &lt;code&gt;geojson&lt;/code&gt;. Por isso a classe com os testes relacionados ao comportamento do formul√°rio.&lt;/p&gt;
&lt;h3 id=&#34;registrando-modelo-no-admin&#34;&gt;Registrando modelo no admin&lt;/h3&gt;
&lt;p&gt;Para facilitar, vou usar o django-admin. Trata-se de uma aplica√ß√£o j√° criada onde basta registrar os modelos e views que estamos trabalhando para termos uma interface &amp;ldquo;frontend&amp;rdquo; gen√©rica.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#admin.py
from django.contrib import admin
from map_proj.core.models import Fenomeno
from map_proj.core.forms import FenomenoForm

class FenomenoAdmin(admin.ModelAdmin):
    model = Fenomeno
    form = FenomenoForm

admin.site.register(Fenomeno, FenomenoAdmin)

&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;to-be-continued&#34;&gt;To be continued&amp;hellip;&lt;/h3&gt;
&lt;p&gt;At√© o momento j√° temos algo bastante interessante: um sistema de CRUD que nos permite adicionar, editar e remover dados geogr√°ficos. Talvez voc√™ esteja pensando consigo mesmo:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&amp;ldquo;OK. Mas o que foi feito at√© agora, poderia ter sido feito basicamente com uma base de dados que possuam as colunas latitude e longitude&amp;rdquo;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Eu diria que sim, at√© certo ponto. Uma grande diferen√ßa, eu diria, da forma como foi implementada √© o uso das ferramentas de valida√ß√£o dos dados com o m√≥dulo &lt;code&gt;geojson&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;A ideia √©, a seguir (e seja l√° quando isso for), extender a funcionalidade do sistema ao implementar um webmap para visualizar os dados mapeados.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Artigo publicado tamb√©m no &lt;a href=&#34;https://www.linkedin.com/pulse/criando-um-sistema-para-gest%C3%A3o-de-dados-geogr%C3%A1ficos-e-felipe-/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;linkedin&lt;/strong&gt;&lt;/a&gt;&lt;/em&gt;.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Domestic Economy chatbot</title>
      <link>/project/domestic-economy/</link>
      <pubDate>Wed, 27 Apr 2016 00:00:00 +0000</pubDate>
      <guid>/project/domestic-economy/</guid>
      <description></description>
    </item>
    
  </channel>
</rss>
